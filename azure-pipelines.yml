trigger:
- main

pr:
- main

resources:
- repo: self

variables:
- group: logistics

- name: dockerRegistryServiceConnection
  value: '44896305-bb29-44ac-bbe4-93cfea0c3371'

- name: imageRepository
  value: 'pavanpatilshippingratecalculator'

- name: containerRegistry
  value: 'losgisticsprod.azurecr.io'

- name: dockerfilePath
  value: '$(Build.SourcesDirectory)/Dockerfile'

- name: tag
  value: '$(Build.BuildId)'

- name: vmImageName
  value: 'logistics'



stages:
- stage: QualityAndBuild
  displayName: SonarCloud Quality Gate + Docker Build
  jobs:
  - job: Build
    displayName: Quality Check and Build
    pool:
      name: $(vmImageName)

    steps:
    # -------------------------------------------------
    # 1. Checkout (FULL history required for blame)
    # -------------------------------------------------
    - checkout: self
      fetchDepth: 0
      clean: true

    # -------------------------------------------------
    # 2. SonarCloud - Prepare Analysis
    # -------------------------------------------------
    # - task: SonarCloudPrepare@4
    #   inputs:
    #     SonarQube: 'sonarcloud'
    #     organization: 'techwithpatil'
    #     scannerMode: 'cli'
    #     configMode: 'manual'
    #     cliProjectKey: 'techwithpatil_logistics'
    #     cliProjectName: 'logistics'
    #     cliSources: '.'

    # -------------------------------------------------
    # 3. SonarCloud - Analyze Code
    # -------------------------------------------------
    # - task: SonarCloudAnalyze@4
    #   inputs:
    #     jdkversion: 'JAVA_HOME_17_X64'

    # -------------------------------------------------
    # 4. SonarCloud - Enforce Quality Gate
    # -------------------------------------------------
    # - task: SonarCloudPublish@4
    #   inputs:
    #     pollingTimeoutSec: '300'
      


# --------------------------------
# Docker Build (LOCAL only)
# --------------------------------
    - task: Docker@2
      displayName: Docker Build
      condition: succeeded()
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)


    # -------------------------------------------------
    # 3. Install Trivy
    # -------------------------------------------------
    - script: |
        mkdir -p $(HOME)/bin
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b $(HOME)/bin
        echo "##vso[task.prependpath]$(HOME)/bin"
        pwd
        trivy --version
      displayName: Install Trivy


    # -------------------------------------------------
    # 4. Trivy Scan (Fail on HIGH / CRITICAL)
    # -------------------------------------------------
    - script: |
        trivy image \
          --exit-code 1 \
          --severity HIGH,CRITICAL \
          --format table \
          $(containerRegistry)/$(imageRepository):$(tag)
      displayName: Trivy Image Scan
      condition: succeeded()

    # -------------------------------------------------
    # 5. Generate Trivy Report (JUnit)
    # -------------------------------------------------
    - script: |
        trivy image \
          --severity HIGH,CRITICAL \
          --format template \
          --template "@contrib/junit.tpl" \
          -o $(Build.ArtifactStagingDirectory)/trivy-report.xml \
          $(containerRegistry)/$(imageRepository):$(tag)
      displayName: Generate Trivy Report
      condition: succeededOrFailed()

    # -------------------------------------------------
    # 6. Publish Trivy Report
    # -------------------------------------------------
    - task: PublishTestResults@2
      displayName: Publish Trivy Report
      inputs:
        testResultsFormat: JUnit
        testResultsFiles: '$(Build.ArtifactStagingDirectory)/trivy-report.xml'
        mergeTestResults: true
        failTaskOnFailedTests: false
        testRunTitle: Trivy Vulnerability Scan

# --------------------------------
# Docker Push (ONLY if scan passed)
# --------------------------------
    - task: Docker@2
      displayName: Docker Push
      condition: succeeded()
      inputs:
        command: push
        repository: $(imageRepository)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
