trigger:
- main

pr:
- main

resources:
- repo: self

variables:
- group: logistics

- name: dockerRegistryServiceConnection
  value: '44896305-bb29-44ac-bbe4-93cfea0c3371'

- name: imageRepository
  value: 'pavanpatilshippingratecalculator'

- name: containerRegistry
  value: 'losgisticsprod.azurecr.io'

- name: dockerfilePath
  value: '$(Build.SourcesDirectory)/Dockerfile'

- name: tag
  value: '$(Build.BuildId)'

- name: vmImageName
  value: 'logistics'

stages:
- stage: QualityAndBuild
  displayName: 'SonarQube Quality Gate + Docker Build'
  jobs:
  - job: Build
    displayName: 'Quality Check and Build'
    pool:
      name: $(vmImageName)

    steps:
    # -------------------------------------------------
    # 1. Checkout (FULL history required for blame)
    # -------------------------------------------------
    - checkout: self
      fetchDepth: 0
      clean: true

    # -------------------------------------------------
    # 2. SonarQube - Prepare Analysis
    # -------------------------------------------------
    - task: SonarQubePrepare@8
      inputs:
        SonarQube: 'kvm-sonarqube'
        scannerMode: 'cli'
        configMode: 'manual'
        cliProjectKey: 'logistics-shipping-rate-calculator'
        cliProjectName: 'shipping-rate-calculator'
        cliProjectVersion: '1.0.$(Build.BuildId)'
        cliSources: '.'

    # -------------------------------------------------
    # **NEW** Remove sonar.branch.name (Community Edition Fix)
    # -------------------------------------------------
    - script: |
        # Remove sonar.branch.name from environment params for main branch only
        if [ -n "$SONARQUBE_SCANNER_PARAMS" ]; then
          export SONARQUBE_SCANNER_PARAMS=$(echo "$SONARQUBE_SCANNER_PARAMS" | sed 's/"sonar.branch.name":"[^"]*"[,]*//g')
          echo "Updated SONARQUBE_SCANNER_PARAMS (branch prop removed): $SONARQUBE_SCANNER_PARAMS"
        fi
        echo "##vso[task.setvariable variable=SONARQUBE_SCANNER_PARAMS]$SONARQUBE_SCANNER_PARAMS"
      displayName: 'Remove sonar.branch.name for Community Edition'
      env:
        SONARQUBE_SCANNER_PARAMS: $(SONARQUBE_SCANNER_PARAMS)

    # -------------------------------------------------
    # 3. SonarQube - Analyze Code
    # -------------------------------------------------
    - task: SonarQubeAnalyze@8
      inputs:
        jdkversion: 'JAVA_HOME_17_X64'

    # -------------------------------------------------
    # 4. SonarQube - Enforce Quality Gate
    # -------------------------------------------------
    - task: SonarQubePublish@8
      inputs:
        pollingTimeoutSec: '300'

    # -------------------------------------------------
    # Docker Build (LOCAL only)
    # --------------------------------
    - task: Docker@2
      displayName: 'Docker Build'
      condition: succeeded()
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

    # -------------------------------------------------
    # 3. Install Trivy (Non-root safe)
    # -------------------------------------------------
    - script: |
        mkdir -p $(HOME)/bin
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b $(HOME)/bin
        echo "##vso[task.prependpath]$(HOME)/bin"
        trivy --version
        pwd
      displayName: 'Install Trivy'

    # -------------------------------------------------
    # 4. Trivy Image Scan (FAIL on HIGH / CRITICAL)
    # -------------------------------------------------
    - script: |
        trivy image \
          --exit-code 1 \
          --severity HIGH,CRITICAL \
          --format table \
          $(containerRegistry)/$(imageRepository):$(tag)
      displayName: 'Trivy Image Scan'
      condition: succeeded()

    # -------------------------------------------------
    # Docker Push (ONLY if scan passed)
    # --------------------------------
    - task: Docker@2
      displayName: 'Docker Push'
      condition: succeeded()
      inputs:
        command: push
        repository: $(imageRepository)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
