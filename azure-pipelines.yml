trigger:
- main

pr:
- main

resources:
- repo: self

variables:
- group: logistics

- name: dockerRegistryServiceConnection
  value: '44896305-bb29-44ac-bbe4-93cfea0c3371'

- name: imageRepository
  value: 'pavanpatilshippingratecalculator'

- name: containerRegistry
  value: 'losgisticsprod.azurecr.io'

- name: dockerfilePath
  value: '$(Build.SourcesDirectory)/Dockerfile'

- name: tag
  value: '$(Build.BuildId)'

- name: vmImageName
  value: 'logistics'



stages:
- stage: QualityAndBuild
  displayName: SonarCloud Quality Gate + Docker Build
  jobs:
  - job: Build
    displayName: Quality Check and Build
    pool:
      name: $(vmImageName)

    steps:
    # -------------------------------------------------
    # 1. Checkout (FULL history required for blame)
    # -------------------------------------------------
    - checkout: self
      fetchDepth: 0
      clean: true

    # -------------------------------------------------
    # 2. SonarCloud - Prepare Analysis
    # -------------------------------------------------
    # - task: SonarCloudPrepare@4
    #   inputs:
    #     SonarQube: 'sonarcloud'
    #     organization: 'techwithpatil'
    #     scannerMode: 'cli'
    #     configMode: 'manual'
    #     cliProjectKey: 'techwithpatil_logistics'
    #     cliProjectName: 'logistics'
    #     cliSources: '.'

    # -------------------------------------------------
    # 3. SonarCloud - Analyze Code
    # -------------------------------------------------
    # - task: SonarCloudAnalyze@4
    #   inputs:
    #     jdkversion: 'JAVA_HOME_17_X64'

    # -------------------------------------------------
    # 4. SonarCloud - Enforce Quality Gate
    # -------------------------------------------------
    # - task: SonarCloudPublish@4
    #   inputs:
    #     pollingTimeoutSec: '300'
      
    # -------------------------------------------------
    # 4. SnykCloud - Application dependencies scan
    # -------------------------------------------------

    # -------------------------------------------------
    # 5. Snyk App Scan (Python 3.11 container)
    # -------------------------------------------------
    # - script: |
    #     docker run --rm \
    #       -v $(Build.SourcesDirectory):/project \
    #       -w /project \
    #       python:3.11-slim \
    #       sh -c "
    #         apt-get update && apt-get install -y curl &&
    #         curl -sSL https://static.snyk.io/cli/latest/snyk-linux -o snyk &&
    #         chmod +x snyk &&
    #         ./snyk auth \$snyk_token &&
    #         ./snyk test --file=requirements.txt --severity-threshold=high
    #       "
    #   displayName: Snyk Open Source Scan (Python 3.11)
    #   env:
    #     snyk_token: $(snyk_token)

    - task: SnykSecurityScan@1
      inputs:
        serviceConnectionEndpoint: 'snyk-cloud'
        testType: 'app'
        targetFile: 'requirements.txt'
        severityThreshold: 'high'
        monitorWhen: 'always'
        failOnIssues: true

    # -------------------------------------------------
    # 4. SnykCloud - Application code scan
    # -------------------------------------------------
    - task: SnykSecurityScan@1
      inputs:
        serviceConnectionEndpoint: 'snyk-cloud'
        testType: 'code'
        codeSeverityThreshold: 'high'
        failOnIssues: true

# --------------------------------
# Docker Build (LOCAL only)
# --------------------------------
    - task: Docker@2
      displayName: Docker Build
      condition: succeeded()
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

    - task: SnykSecurityScan@1
      inputs:
        serviceConnectionEndpoint: 'snyk-cloud'
        testType: 'container'
        dockerImageName: '$(imageRepository):$(tag)'
        severityThreshold: 'critical'
        monitorWhen: 'always'
        failOnIssues: true
# --------------------------------
# Docker Push (ONLY if scan passed)
# --------------------------------
    - task: Docker@2
      displayName: Docker Push
      condition: succeeded()
      inputs:
        command: push
        repository: $(imageRepository)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
